<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="style.css">
    <script src="quizes.js"></script>

    <title>Welcome</title>
    <style>
      .btn-light, .btn-light:hover, .btn-light:active, .btn-light:visited {
          background-color: #darkgray !important;
          border-color: white !important;
      }
      /*.grid:not(img) {
        transform: rotateX(50deg) rotateZ(55deg);
      }*/
    </style>
  </head>
  <body>
    <div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
      <h5 class="my-0 mr-md-auto font-weight-normal">Spanish</h5>
      <nav class="my-2 my-md-0 mr-md-3">
        <!-- <a class="p-2 text-dark" href="#">Features</a> -->
        <!-- <a class="p-2 text-dark" href="#">Enterprise</a> -->
        <!-- <a class="p-2 text-dark" href="#">Help</a> -->
        <!-- <a class="p-2 text-dark" href="#">Squares</a> -->
        <div class="dropdown">
          <button class="btn btn-light text-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Theme
          </button>
          <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <a class="dropdown-item" href="#" onclick="change_theme('primary')">Blue</a>
            <a class="dropdown-item" href="#" onclick="change_theme('secondary')">Gray</a>
            <a class="dropdown-item" href="#" onclick="change_theme('success')">Green</a>
            <a class="dropdown-item" href="#" onclick="change_theme('info')">Turquiose</a>
            <a class="dropdown-item" href="#" onclick="change_theme('warning')">Orange</a>
            <a class="dropdown-item" href="#" onclick="change_theme('danger')">Red</a>
            <a class="dropdown-item" href="#" onclick="change_theme('light')">Light</a>
            <a class="dropdown-item" href="#" onclick="change_theme('dark')">Dark</a>
            <a class="dropdown-item" href="#" onclick="clear_theme()">Original</a>
          </div>
        </div>
      </nav>
      <a class="btn btn-outline-primary text-primary" href="#" id="user" onclick="signin_user()">User</a>
    </div>

    <script type="text/javascript">
      function sigup_modal() {
        $("#exampleModal").modal('show');
      }
      function signup_submit() {
        user.name = $("#userInputName").val();
        user.email = $("#userInputEmail").val();
        user.id = $("#userInputEmail").val();
        user.id = user.id.replace(/\@.*/, ''); // first part of email
        set_user(user);
        $("#exampleModal").modal('hide');
      }
    </script>

    <!-- Modal -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-body">
            <div class="col-sm-9 col-md-7 col-lg-5 mx-auto">
              <div class="card card-signin my-5">
                <div class="card-body">
                  <h5 class="card-title text-center">Create User</h5>
                  <form>
                    <div class="form-group">
                      <label for="userInputName">Name</label>
                      <input type="text" class="form-control" id="userInputName" aria-describedby="nameHelp" placeholder="Enter Name">
                      <small id="emailHelp" class="form-text text-muted">First name will do.</small>
                    </div>
                    <div class="form-group">
                      <label for="userInputEmail">Email address</label>
                      <input type="email" class="form-control" id="userInputEmail" aria-describedby="emailHelp" placeholder="Enter email">
                      <small id="emailHelp" class="form-text text-muted">Will be your primary user-id.</small>
                    </div>
                    <!-- <div class="form-group">
                      <label for="userInputPassword1">Password</label>
                      <input type="password" class="form-control" id="userInputPassword1" placeholder="Password">
                    </div> -->
                    <button type="submit" class="btn btn-primary" onclick="signup_submit()">Submit</button>
                  </form>
                </div>
              </div>
            </div>
          </div>
          <!-- <div class="modal-footer"> -->
            <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button> -->
            <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
          <!-- </div> -->
        </div>
      </div>
    </div>

    <script>
      let theme = get_theme() || 'primary';
      let classnames = ['btn-primary', 'btn-outline-primary', 'bg-primary', 'border-primary', 'text-primary'];
      // let lookup = {blue: primary, gray: secondary, green: }
      function change_theme(theme_new, theme_old=theme) {
        console.log(`........... changing theme ................`);
        console.log(`old-theme = ${theme_old}`)
        console.log(`new-theme = ${theme_new}`)
        // let elements = document.querySelectorAll(["class$="+theme_old]);
        let elements = document.querySelectorAll("*");
        for(let element of elements) {
          for(let classname of classnames) {
            let classname_old = classname.replace('primary', theme_old);
            let classname_new = classname.replace('primary', theme_new);
            // if(classname_new.match(/text/)) {
            //   console.log(`==================== ${classname_old} -> ${classname_new} ================`)
            //   classname_old = (theme_new==='light') ? 'text-white' : 'text-muted';
            //   classname_new = (theme_new==='light') ? 'text-muted' : 'text-white';
            //   console.log(`==================== ${classname_old} -> ${classname_new} ================`)
            // }
            if(is_exempt(element)) continue;

            if($(element).hasClass('text-muted') && theme_new!=='light') {
              $(element).removeClass('text-muted');
              $(element).addClass('text-white');
            }
            if($(element).hasClass('text-white') && theme_new==='light') {
              $(element).removeClass('text-white');
              $(element).addClass('text-muted');
            }
            if($(element).hasClass(classname_old) && theme_new==='light') {
              $(element).removeClass('text-light');
              $(element).addClass('text-muted');
            }
            if($(element).hasClass('bg-light') && theme_new!=='light') {
              $(element).removeClass('bg-light');
              $(element).addClass('bg-'+theme_new);
            }
            // if(!has_class(element, classname_old)) continue;
            // remove_class(element, classname_old);
            // add_class(element, classname_new);
            if(!$(element).hasClass(classname_old)) continue;
            console.log(`........... changing class ................`);
            console.log(`old-class = ${classname_old}`)
            console.log(`new-class = ${classname_new}`)
            $(element).removeClass(classname_old);
            $(element).addClass(classname_new);
            // $(element).addClass('border-primary');
          }
        }
        theme = theme_new;
        save_theme(theme);
      }
      function is_exempt(element) {
        let list = ['btn0', 'btn1', 'btn2', 'btn3', 'check-progress', 'send-progress', 'clear_storage'];
        for(let id of list) { if(element.id===id) return true }
        if($(element).hasClass("text-exempt")) return true;
        return false;
      }
      function set_theme(theme) {
        if(!theme) theme = get_theme();
        // if(!theme) theme = 'primary';
        if(!theme) return;
        change_theme(theme);
      }
     function get_theme() {
        return window.localStorage.getItem(user.id+'/theme');
      }
     function save_theme(_theme) {
        _theme = _theme || theme;
        return window.localStorage.setItem(user.id+'/theme', theme);
      }
     function clear_theme() {
        window.localStorage.removeItem(user.id+'/theme');
        if(confirm("Original theme setting needs to reload this page.\nPress 'OK' to reload now.\nPress 'Cancel' to reload later.")) location.reload();
      }
     </script>

    <div class="squares-header px-3 py-3 pt-md-3 pb-md-3 mx-auto text-center">
      <!-- <h3 class="display-5">Colors</h3> -->
      <p class="lead" id="quiz-card-topic-text">Primary colors</p>
    </div>

    <script>
      let results = [];
      let index = 0;
      let user = {}; //name, email, id
      let info = {}; //project-name, current-quiz-topic
      let quiz;
      let oneoff = false;
      let building_num = 0;
      // user = { name: 'Parminder', email: 'pgill18.dev@gmail.com', id: 'pgill18.dev' };
      let fileName = 'myData.json'; // for save-as
      $( document ).ready(function(){
        signin_user(user);
        // set_user(user);
        load_page();
        load_quiz();
        set_theme();
        // quiz = load_quiz();
        // load_question(index);
        // let data = window.localStorage.getItem(user.id);
      });
      function load_page() {
        for(let i=0; i<quizes.length; i++) {
          if(i>MAX_QUIZES-1) continue;
          let {info, quiz} = quizes[i];
          state = i<3 ? 1 : i<5 ? 0.5 : 0;
          load_building(i, quiz, info, {state});
          // $(`#building-${i}-header`).text(info.header);
          // $(`#building-${i}-count`).text(quiz.length);
        }
      }
      // function next_step() {
      //   save_results(index);
      //   load_question(++index);
      // }
      function next_step() {
        // load_question(++index);
        if(oneoff) {
          save_results(index);
          publish_results(results);
          refresh_building(building_num);
          $(".track-progress").prop("disabled", false);
        } else {
          save_results(index);
          load_question(++index);
        }
        oneoff = false;
      }
      function run_step(question) {
        load_quiz_window();
        quiz.forEach(function(entry, i) { if(entry[0]===question) index=i });
        load_question(index);
        console.log(`load_question(${index})`);
        console.log(`quiz.length=${quiz.length}`);
        oneoff = true;
      }

      function load_quiz(x=0) {
        quiz = quizes[x].quiz;
        info = quizes[x].info;
        index = 0;
        load_quiz_window();
        load_question(index);
        building_num = x;
      }
      function load_question(index) {
        console.log(`load_question(${index})`);
        clear_form(index);
        if(index > quiz.length-1) return 0;
        let entry = quiz[index]
        let choices = entry[2];
        let question = entry[0], expected = entry[1];
        console.log(`.............................index=${index}`);
        console.log(quiz);
        console.log(entry);
        console.log(question);
        console.log(choices);
        for(let i=0; i<choices.length; i++) {
          $("#choice"+i).text(capitalizeFirstLetter(choices[i]));
        }
        $("#question").text(capitalizeFirstLetter(question));
        return 1;
      }
      function clear_form() {
        console.log(`clear_form(${index})`);
        if(index > quiz.length-1) {
          publish_results(results);
          refresh_building(building_num);
          // $("#check-progress").prop("disabled", false);
          // $("#send-progress").prop("disabled", false);
          $(".track-progress").prop("disabled", false);
          return 0;
        }
        let entry = quiz[index]
        let choices = entry[2];
        for(let i=0; i<choices.length; i++) {
          if($("#cbx"+i).prop("checked"))
            $("#btn"+i).click();
        }
        $("#btn-next").prop("disabled", true);
        $("#btn-prev").prop("disabled", true);
        $(".track-progress").prop("disabled", true);
        // $("#check-progress").prop("disabled", true);
        // $("#send-progress").prop("disabled", true);
      }
      function load_quiz_window() {
        console.log(`load_quiz_window()`);
          let results_html = `
              <!-- <h5 class="card-title building-card-title text-center text-white col-8" id="quiz-card-title"><span id="question" style="_padding:200px; color:slategray">Color Green</span></h5> -->
              <div class="row justify-content-center">
                 <!-- <a type="button" class="btn btn-md btn-block btn-link col-8 text-left" style="padding-left:20px"><span style="padding-left:20px">Harra</span></a> -->
                 <h5 class="card-title building-card-title text-left text-white col-8" id="quiz-card-title"><span id="question" style="padding:20px; color:slategray">Color Green</span></h5>
                 <div class="btn-group-vertical col-8" role="group" aria-label="Basic example">
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn0" onclick="checkbox1(0)"><input id="cbx0" type="checkbox" onclick="checkbox(0)"><span id="choice0" style="padding-left:20px">Harra</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn1" onclick="checkbox1(1)"><input id="cbx1" type="checkbox" onclick="checkbox(1)"><span id="choice1" style="padding-left:20px">Neela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn2" onclick="checkbox1(2)"><input id="cbx2" type="checkbox" onclick="checkbox(2)"><span id="choice2" style="padding-left:20px">Peela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn3" onclick="checkbox1(3)"><input id="cbx3" type="checkbox" onclick="checkbox(3)"><span id="choice3" style="padding-left:20px">Kaala</span>
                </div>
              </div>
              <br>
              <div class="row justify-content-center">
                <div class="btn-group col-8" role="group" aria-label="Basic example buttons">
                  <button type="button" class="btn btn-md btn-outline-primary text-primary" id="btn-prev" style="width:20%">Prev</button>
                  <button type="button" class="btn btn-md btn-primary" id="btn-next" style="width:20%" onclick="next_step()">Next</button>
                </div>
              </div>
          `;
          $("#quiz-card-body").html(results_html);
          $("#quiz-card-header-text").text(info.header);
          $("#quiz-card-topic-text").text(info.topic);
          // $(window).scrollTop(0);
          window.scrollTo({ top: 0, behavior: 'smooth' });
      }
      function load_building(i, quiz, info, {state=1}={}) {
          let results_html = `
              <div class="card-header">
                <div class="row justify-content-center">
                  <h4 class="my-0 font-weight-normal text-center" id="building-${i}-header">Colors</h4>
                  <div class="badge badge-light text-muted text-exempt"><span id="building-${i}-count">0</span></div>
                </div>
              </div>
              <div class="card-body pt-1">
                <!-- <h4 class="card-title building-card-title"><span class="text-muted">Level</span> 1</h4> -->
                <ul class="list-unstyled mb-0">
                  <!-- <li><span id="building-${i}-count">0</span> items</li> -->
                  <!-- <li><small class="text-muted">Avg 3</small><small class="text-muted">, Min 2</small></li> -->
                  <!-- <li><em class="text-muted text-exempt">Level 1</em></li> -->
                  <li class="text-center"><em class="text-muted text-exempt">Level <span id="building-${i}-level">1</span></em></li>
                  <li class="text-center"><h6 class="text-muted text-exempt"><span id="building-${i}-done">0</span>% done</h6></li>
                </ul>
                <button type="button" class="btn btn-link btn-block track-progress" id="building-${i}-progress-btn" onclick="check_progress(${i})">Check Progress</button>
                <hr>
                <button type="button" class="btn btn-lg btn-block btn-outline-primary text-primary" id="building-${i}-start-btn" onclick="load_quiz(${i})">Start</button>
            </div>
          `;
            // <div class="col mb-4">
            // </div>

          let building_column = document.createElement("div");
          building_column.className = "col mb-2";
          $("#quiz-buildings").append(building_column);
          let building = document.createElement("div");
          building.className = "card mb-4 shadow-sm";
          building.innerHTML = results_html;
          // $(building).addClass('shrink60');
          $(building_column).append(building);
          // $("#quiz-buildings").append(building);
          $(`#building-${i}-header`).text(info.header);
          $(`#building-${i}-count`).text(quiz.length);
          let quiz_level = 1, quiz_done = 33;
          let {db, report, results} = get_progress(i);
          console.log({db, report, results});
          quiz_done = Math.round(report.summary.attempts/3 * 100) || 0;
          $(`#building-${i}-level`).text(quiz_level);
          $(`#building-${i}-done`).text(quiz_done);
          // fade buildings in ruin
          if(state<1) disable_appearance(building, {disable: true, opacity: state>0?0.3:0.1});
          if(state<1) disable_appearance(`#building-${i}-progress-btn`, {disable: true, opacity: state>0?0.2:0.1});
          if(state<1) disable_appearance(`#building-${i}-start-btn`, {disable: true, opacity: state>0?0.1:0.1});
      }
      function refresh_building(i, quiz, info) {
          let quiz_level = 1, quiz_done = 33;
          let {db, report, results} = get_progress(i);
          console.log({db, report, results});
          quiz_done = Math.round(report.summary.attempts/3 * 100) || 0;
          quiz_done = Math.round(report.summary.attempts/3 * 100);
          console.log(`quiz_done = ${quiz_done}`);
          $(`#building-${i}-level`).text(quiz_level);
          $(`#building-${i}-done`).text(quiz_done);
      }
      function disable_appearance(element, opt) {
        $(element).prop("disabled", opt.disable);
        $(element).css({opacity: opt.opacity});
      }
      function publish_results(results) {
          $("#quiz-card-title").html('Results');
          let results_html = '';
          let tablerows = '';
          for(let i=0; i<results.length; i++) {
            let {question, expected, answer, pass, choices} = results[i];
            let passfail = pass ? "PASSED" : "FAILED";
            question = capitalizeFirstLetter(question);
            expected = capitalizeFirstLetter(expected);
            answer = capitalizeFirstLetter(answer);
            // results_html += '<li>' + JSON.stringify(results[i]) + '</li>';
            // let bgcolor = pass ? "lightgreen" : "lightsalmon";
            let bgcolor = pass ? "#ABEBC6" : "#fdd0cb";
            // tablerows += `<tr style="background-color: ${bgcolor}" href="#"  onclick="check_progress()">\n<td  onclick="check_progress()">${question}</td>\n<td>${expected}</td>\n<td>${answer}</td>\n<td>${passfail}</td>\n<tr>`
            tablerows += `<tr style="background-color: ${bgcolor}">\n`;
            for(let field of [question, expected, answer, passfail]) {
              tablerows += `<td><a style="cursor: pointer;" onclick="run_step('${question}');">${field}</a></td>\n`;
            }
            tablerows += `</tr>`;
          }
          // results_html = `<ul>${results_html}</ul>`;
          results_html = `
            <table id="classTable" class="table table-bordered table-sm">
              <thead>
                <th>Question</th><th>Answer</th><th>Your Answer</th><th>Result</th>
              </thead>
              <tbody>
                ${tablerows}
              </tbody>
            </table>
          `;
          // results_html = JSON.stringify(results);
          $("#quiz-card-body").html(results_html);
          console.log(JSON.stringify(results));
          store_results(results);
      }
      function publish_report(report) {
          if(!report || !report.table) return;
          $("#quiz-card-title").html('Results');
          let report_html = '';
          let tablerows = '';
          for(let i=0; i<report.table.length; i++) {
            let {question, expected, correct, incorrect, choices} = report.table[i];
            question = capitalizeFirstLetter(question);
            expected = capitalizeFirstLetter(expected);
            let confidence = incorrect===0 ? 100 : Math.round(correct/(correct+incorrect)*100);
            // let bgcolor = correct>incorrect ? "lightgreen" : "lightsalmon";
            let bgcolor = correct>incorrect ? "#ABEBC6" : "#fdd0cb";
            tablerows += `<tr style="background-color: ${bgcolor}"  onclick="check_progress()">\n<td>${question}</td>\n<td>${expected}</td>\n<td>${correct}</td>\n<td>${incorrect}</td>\n<td>${confidence}</td>\n<tr>`
            // tablerows += `<tr style="background-color: ${bgcolor}">\n`;
            // for(let field of [question, expected, correct, incorrect, confidence]) {
            //   tablerows += `<td><a style="cursor: pointer;" onclick="run_step('${question}')">${field}</a></td>\n`;
            // }
            // tablerows += `</tr>`;
          }
          // results_html = `<ul>${results_html}</ul>`;
          report_html = `
            <table id="classTable" class="table table-bordered table-sm">
              <thead>
                <th>Question</th><th>Answer</th><th>Correct count</th><th>Incorrect count</th><th>Confidence %</th>
              </thead>
              <tbody>
                ${tablerows}
              </tbody>
            </table>
          `;
          // results_html = JSON.stringify(results);
          $("#quiz-card-body").html(report_html);
          console.log(JSON.stringify(results));
          // store_results(results);
      }
      function generate_report(all_results) {
        let report = {table: [], summary: {count: 0, attempts: 0, correct: 0, incorrect: 0}};
        let index_lookup = {};
        for(let results of all_results) { // all attempts
          for(let i=0; i<results.length; i++) { // ith question
            let {question, expected, answer, pass, choices} = results[i];
            if(index_lookup[question]===undefined) index_lookup[question] = i;
            let index = index_lookup[question];
            let correct = (report.table[index] && report.table[index].correct) ? report.table[index].correct : 0;
            let incorrect = (report.table[index] && report.table[index].incorrect) ? report.table[index].incorrect : 0;
            if(pass) correct++; else incorrect++;
            if(pass) report.summary.correct++; else report.summary.incorrect++;
            report.table[index] = {question, expected, correct, incorrect, choices};
          }
          report.summary.count = results.length;
        }
        report.summary.attempts = all_results.length;
        return report;
      }
      function store_results(results) {
        let pathkey = `${info.project}/${info.section}/${info.topic}`;
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) db[pathkey] = {};
        if(!db[pathkey].report) db[pathkey].report = {table: [], summary: {}};
        if(!db[pathkey].results) db[pathkey].results = [];
        // db[pathkey].results.push(results);
        if(oneoff)
          db[pathkey].results[db[pathkey].results.length-1] = results;
        else
          db[pathkey].results.push(results);
        db[pathkey].report = generate_report(db[pathkey].results);
        console.log(db);
        window.localStorage.setItem(user.id, JSON.stringify(db));
      }
      function retrieve_results(i) {
        let pathkey = `${info.project}/${info.section}/${info.topic}`;
        if(i !== undefined) {
          let info = quizes[i].info;
          pathkey = `${info.project}/${info.section}/${info.topic}`;
        }
        let db = window.localStorage.getItem(user.id);
        // console.log(db);
        if(!db) db = {}; else db = JSON.parse(db);
        if(!db[pathkey]) db[pathkey] = {};
        if(!db[pathkey].report) db[pathkey].report = {table: [], summary: {}};
        if(!db[pathkey].results) db[pathkey].results = [];
        console.log(`i = ${i},  building_num = ${building_num}`);
        console.log(`pathkey = ${pathkey}`);
        console.log(db);
        return {db, report: db[pathkey].report, results: db[pathkey].results};
      }
      function check_progress(i) {
        // window.localStorage.clear();
        // window.localStorage.setItem(user.id, "");
        console.log(window.localStorage);
        let {db, report, results} = retrieve_results(i);
        console.log(report);
        publish_report(report);
        oneoff = false;
      }
      function get_progress(i) {
        let {db, report, results} = retrieve_results(i);
        return {db, report, results};
      }
      function clear_local_storage() {
        window.localStorage.clear();
        set_user(user);
      }
      function capitalizeFirstLetter(string) {
        return string.charAt(0).toUpperCase() + string.slice(1);
      }
      function load_user() {
        let user_data = window.localStorage.getItem('user');
        user_data = JSON.parse(user_data);
        user.name = user_data.name;
        user.email = user_data.email;
        user.id = user_data.id;
        console.log(user);
        return user;
      }
      function set_user(user) {
        if(!user || !user.id) user = load_user();
        console.log(user);
        window.localStorage.setItem('user', JSON.stringify(user));
        let firstname = user.name.replace(/(\w+)\s.*/, '$1'); // display only first name
        $("#user").text(firstname);
      }
      function signin_user(user) {
        if(window.localStorage.getItem('user')) {
          set_user(user); return;
        }
        sigup_modal();
      }

      function save_results(index) {
        if(index > quiz.length-1) return 0;
        let entry = quiz[index]
        let choices = entry[2];
        let question = entry[0], expected = entry[1], answer;
        for(let i=0; i<choices.length; i++) {
          console.log(`.....${i} ` + $("#cbx"+i).prop("checked"))
          if($("#cbx"+i).prop("checked")) {
            // console.log('.....yeaah')
            answer = choices[i]; break;
          }
        }
        let pass = (answer===entry[1]);
        console.log(pass?'PASSED':'FAILED');
        let result = {question, expected, answer, pass, choices};
        results[index] = result;
        console.log(results);
      }

      function checkbox(i) {
        $("#btn"+i).click();
        $("#btn-next").prop("disabled", false);
      }
      function checkbox1(i) {
        $("#cbx"+i).prop("checked", ! $("#cbx"+i).prop("checked"));
        $("#btn-next").prop("disabled", false);
      }

      function download_progress() {
        var button = document.getElementById('send-progress');
        if(button.textContent!=='Send Progress') {
          button.textContent = "Send Progress";
          return;
        }
        let obj = window.localStorage.getItem(user.id);
        let data = "text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(obj, null, 2));
        var a = document.createElement('a');
        a.href = 'data:' + data;
        a.download = 'data.json';
        a.innerHTML = 'Download';
        button.textContent = "";
        button.appendChild(a);
      }
    </script>

    </div>
      <div class="container">
        <div class="card-deck mb-3 text-center">
          <div class="card mb-4 shadow" id="quiz-card">
            <div class="card-header bg-light text-muted" id="quiz-card-header">
              <h4 class="my-0 font-weight-normal" id="quiz-card-header-text">Colors</h4>
            </div>
            <div class="card-body" id="quiz-card-body">
              <h5 class="card-title building-card-title text-left text-muted" id="quiz-card-title"><span id="question" style="padding:200px; color:slategray">Color Green</span></h5>
              <div class="row justify-content-center">
                <div class="btn-group-vertical col-8" role="group" aria-label="Basic example">
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn0" onclick="checkbox1(0)"><input id="cbx0" type="checkbox" onclick="checkbox(0)"><span id="choice0" style="padding-left:20px">Harra</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn1" onclick="checkbox1(1)"><input id="cbx1" type="checkbox" onclick="checkbox(1)"><span id="choice1" style="padding-left:20px">Neela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn2" onclick="checkbox1(2)"><input id="cbx2" type="checkbox" onclick="checkbox(2)"><span id="choice2" style="padding-left:20px">Peela</span>
                  <button type="button" class="btn btn-md btn-block btn-light text-left" data-toggle="button" style="padding-left:20px" id="btn3" onclick="checkbox1(3)"><input id="cbx3" type="checkbox" onclick="checkbox(3)"><span id="choice3" style="padding-left:20px">Kaala</span>
                </div>
              </div>
              <br>
              <div class="row justify-content-center">
                <div class="btn-group col-8" role="group" aria-label="Basic example buttons">
                  <button type="button" class="btn btn-md btn-outline-primary text-primary" id="btn-prev" style="width:20%">Prev</button>
                  <button type="button" class="btn btn-md btn-primary" id="btn-next" style="width:20%" onclick="next_step()">Next</button>
                </div>
              </div>
            </div>
          </div>
        </div>

      <!--        
      <div class="squares-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <div class="card mb-4 shadow-sm">
          <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2">
              <button type="button" class="btn btn-md btn-light col-5 track-progress" onclick="check_progress()" id="check-progress">Check Progress</button>
              <button type="button" class="btn btn-md btn-light col-5 track-progress" onclick="download_progress()" id="send-progress">Send Progress</button>
              <button type="button" class="btn btn-md btn-light progress" onclick="clear_local_storage()" id="clear_storage">Clear local storage</button>
            </div>
          </div>
        </div>
      </div> -->
 
      <!-- <div class="squares-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center"> -->
      <div class="text-center">
        <div class="card mb-0 shadow-sm">
          <div class="card-body py-2">
              <div class="row row-cols-1 row-cols-md-2 justify-content-center">
                <div class="btn-group" role="group" aria-label="Basic example buttons">
                  <button type="button" class="btn btn-md btn-light track-progress" onclick="check_progress()" id="check-progress">Check Progress</button>
                  <button type="button" class="btn btn-md btn-light track-progress" onclick="download_progress()" id="send-progress">Send Progress</button>
                </div>
              </div>
          </div>
        </div>
      </div>

      <div class="squares-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
        <!-- <h3 class="display-5">Colors</h3> -->
        <p class="lead">Current setup</p>
      </div>

      <div class="container">
        <!-- <div class="card-deck mb-3 text-center grid"> -->
          <div class="row row-cols-1 row-cols-md-3" id="quiz-buildings">
          </div>
        <!-- </div> -->
      </div>

      <footer class="pt-4 my-md-5 pt-md-5 border-top">
          <div class="row">
            <div class="col-6 col-md">
              <!-- <h5>Reporting</h5> -->
              <ul class="list-unstyled text-small">
                <li><a class="text-muted text-exempt" href="#" onclick="check_progress()">Check Progress</a></li>
                <!-- <li><a class="text-muted" href="#">Random feature</a></li> -->
                <!-- <li><a class="text-muted" href="#">Team feature</a></li> -->
              </ul>
            </div>
            <div class="col-6 col-md">
              <!-- <h5>Resources</h5> -->
              <ul class="list-unstyled text-small">
                <li><a class="text-muted text-exempt" href="#" onclick="clear_local_storage()">Clear local storage</a></li>
                <!-- <li><a class="text-muted" href="#">Resource name</a></li> -->
                <!-- <li><a class="text-muted" href="#">Another resource</a></li> -->
              </ul>
            </div>
            <div class="col-6 col-md">
              <!-- <h5>About</h5>
              <ul class="list-unstyled text-small">
                <li><a class="text-muted" href="#">Team</a></li>
                <li><a class="text-muted" href="#">Locations</a></li>
              </ul> -->
            </div>
          </div>
        </footer>

  </body>
</html>
